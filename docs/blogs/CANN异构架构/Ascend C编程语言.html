<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-blogs/CANN异构架构/Ascend C编程语言" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Ascend C编程语言 | BUAAer-xing Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://buaaer-xing.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://buaaer-xing.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://buaaer-xing.github.io/docs/blogs/CANN异构架构/Ascend C编程语言"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ascend C编程语言 | BUAAer-xing Blog"><meta data-rh="true" name="description" content="---"><meta data-rh="true" property="og:description" content="---"><link data-rh="true" rel="icon" href="/img/icon.png"><link data-rh="true" rel="canonical" href="https://buaaer-xing.github.io/docs/blogs/CANN异构架构/Ascend C编程语言"><link data-rh="true" rel="alternate" href="https://buaaer-xing.github.io/docs/blogs/CANN异构架构/Ascend C编程语言" hreflang="en"><link data-rh="true" rel="alternate" href="https://buaaer-xing.github.io/docs/blogs/CANN异构架构/Ascend C编程语言" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://YOUR_APP_ID-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ascend C编程语言","item":"https://buaaer-xing.github.io/docs/blogs/CANN异构架构/Ascend C编程语言"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="BUAAer-xing Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="BUAAer-xing Blog Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="BUAAer-xing Blog" href="/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.98cc3bd4.css">
<script src="/assets/js/runtime~main.b1a1434e.js" defer="defer"></script>
<script src="/assets/js/main.8b44110d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/icon.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/icon.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Home</b></a><a class="navbar__item navbar__link" href="/docs/paper_notes_intro">论文笔记</a><a class="navbar__item navbar__link" href="/docs/week_report/week_report_intro">周报汇总</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/blogs_intro">个人博客</a><a class="navbar__item navbar__link" href="/docs/my_papers_intro">发表论文</a><a class="navbar__item navbar__link" href="/blog">相关内容</a><a class="navbar__item navbar__link" href="/resume">个人简历</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/BUAAer-xing/BUAAer-xing.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/blogs_intro">博客说明</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/blogs/Linux学习笔记/Linux基础/虚拟机部分">Linux学习笔记</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/blogs/Fortran语言/笔记/fortran 简介">Fortran语言</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/blogs/高性能计算/高性能计算学习路线/高性能计算的学习路线">高性能计算</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/blogs/CUDA编程学习笔记/Tips/CUDA中的统一虚拟内存">CUDA编程学习笔记</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/blogs/Transformer学习/入门/机器学习与深度学习">Transformer学习</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/blogs/CANN异构架构/概述">CANN异构架构</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/CANN异构架构/概述">概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/CANN异构架构/昇腾AI处理器">昇腾AI处理器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/CANN异构架构/CANN是什么？">CANN是什么？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/blogs/CANN异构架构/Ascend C编程语言">Ascend C编程语言</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/CANN异构架构/AOL算子加速库">AOL算子加速库</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/blogs/CANN异构架构/HCCL集合通信库">HCCL集合通信库</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">CANN异构架构</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Ascend C编程语言</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Ascend C编程语言</h1></header><hr>
<p>大致看了一下，感觉需要记住硬件的特性：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250425151809.png" alt="image.png|center|600" class="img_ev3q"></p>
<p>针对AI Core中的<font color="red"><b>矩阵乘法</b></font>：</p>
<ul>
<li>对于<code>FP16</code>类型的数据：A、B、C的块大小都是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn><mo>×</mo><mn>16</mn></mrow><annotation encoding="application/x-tex">16\times16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">16</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">16</span></span></span></span>，结果会在一拍中给出。</li>
<li>对于<code>int8</code>类型的数据：A的块大小是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>32</mn><mo>×</mo><mn>16</mn></mrow><annotation encoding="application/x-tex">32\times16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">32</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">16</span></span></span></span>、B的块大小是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn><mo>×</mo><mn>32</mn></mrow><annotation encoding="application/x-tex">16\times32</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">16</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">32</span></span></span></span>、C的块大小是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>32</mn><mo>×</mo><mn>32</mn></mrow><annotation encoding="application/x-tex">32\times32</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">32</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">32</span></span></span></span>。</li>
</ul>
<p>针对AI Core中的<font color="red"><b>向量运算</b></font>：</p>
<ul>
<li>针对<code>FP16</code>类型的数据：一拍可以完成两个<strong>128长度</strong>的向量乘加操作。</li>
<li>针对<code>FP32</code>类型的数据：一拍可以完成两个<strong>64长度</strong>的向量乘加操作。</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-ascend-c-简介">1-Ascend C 简介<a href="#1-ascend-c-简介" class="hash-link" aria-label="Direct link to 1-Ascend C 简介" title="Direct link to 1-Ascend C 简介">​</a></h2>
<p>Ascend C是CANN针对算子开发场景推出的编程语言，原生支持C和C++标准规范，兼具开发效率和运行性能。基于Ascend C编写的算子程序，通过编译器编译和运行时调度，运行在昇腾AI处理器上。使用Ascend C，开发者可以基于昇腾AI硬件，高效的实现自定义的创新算法。</p>
<p>📒：<font color="red"><b>可以将Ascend C编程类比于CUDA编程</b></font></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427101836.png" alt="image.png|center|300" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-使用ascend-c的demo">2-使用Ascend C的Demo<a href="#2-使用ascend-c的demo" class="hash-link" aria-label="Direct link to 2-使用Ascend C的Demo" title="Direct link to 2-使用Ascend C的Demo">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-核函数输出hello-world">2.1-核函数输出Hello World<a href="#21-核函数输出hello-world" class="hash-link" aria-label="Direct link to 2.1-核函数输出Hello World" title="Direct link to 2.1-核函数输出Hello World">​</a></h3>
<p>下面是一个简单的Ascend C的&quot;Hello World&quot;样例，展示了一个Ascend C核函数（设备侧实现的入口函数）的基本写法，及其如何被调用的流程。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">包含核函数的实现文件hello_world.cpp代码如下：核函数hello_world的核心逻辑为打印&quot;Hello World!!!&quot;字符串。hello_world_do封装了核函数的调用程序，通过&lt;&lt;&lt;&gt;&gt;&gt;内核调用符对核函数进行调用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;kernel_operator.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token plain"> __global__ __aicore__ </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello_world</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Hello World!!!\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello_world_do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> blockDim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hello_world</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockDim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stream</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;acl/acl.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello_world_do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> coreDim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// AscendCL初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">aclInit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 运行管理资源申请</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> deviceId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">aclrtSetDevice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deviceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aclrtStream stream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">aclrtCreateStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">stream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 设置参与运算的核数为8（核数可根据实际需求设置）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> blockDim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 用内核调用符&lt;&lt;&lt;&gt;&gt;&gt;调用核函数，hello_world_do中封装了&lt;&lt;&lt;&gt;&gt;&gt;调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">hello_world_do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockDim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">aclrtSynchronizeStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 资源释放和AscendCL去初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">aclrtDestroyStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">aclrtResetDevice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deviceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">aclFinalize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-核函数计算两个向量加法demo">2.2-核函数计算两个向量加法Demo<a href="#22-核函数计算两个向量加法demo" class="hash-link" aria-label="Direct link to 2.2-核函数计算两个向量加法Demo" title="Direct link to 2.2-核函数计算两个向量加法Demo">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="算子分析">算子分析<a href="#算子分析" class="hash-link" aria-label="Direct link to 算子分析" title="Direct link to 算子分析">​</a></h4>
<p>Add算子的逻辑表达式是：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>z</mi><mo>⃗</mo></mover><mo>=</mo><mover accent="true"><mi>x</mi><mo>⃗</mo></mover><mo>+</mo><mover accent="true"><mi>y</mi><mo>⃗</mo></mover></mrow><annotation encoding="application/x-tex">\vec{z} = \vec{x} + \vec{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.714em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.04398em">z</span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.1799em"><span class="overlay" style="height:0.714em;width:0.471em"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7973em;vertical-align:-0.0833em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal">x</span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.2077em"><span class="overlay" style="height:0.714em;width:0.471em"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.9084em;vertical-align:-0.1944em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.714em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.1799em"><span class="overlay" style="height:0.714em;width:0.471em"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em"><span></span></span></span></span></span></span></span></span>，计算逻辑是：从外部存储Global Memory搬运数据至内部存储Local Memory，然后使用Ascend C计算接口完成两个输入参数相加，得到最终结果，再搬运到Global Memory上。</p>
<p>本次demo的数据输入输出为：</p>
<ul>
<li>Add算子有两个输入：x与y，输出为z。</li>
<li>本样例中算子输入支持的数据类型为half（float16），算子输出的数据类型与输入数据类型相同。</li>
<li>算子输入支持的shape为（8，2048），输出shape与输入shape相同。</li>
<li>算子输入支持的<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/devguide/opdevg/ascendcopdevg/atlas_ascendc_10_0099.html" target="_blank" rel="noopener noreferrer">format</a>为：ND。</li>
</ul>
<p><center> <font face="华文宋体" size="4"> Ascend C Add算子设计规格 </font> </center>
<img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427104544.png" alt="image.png|center|800" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="核函数开发">核函数开发<a href="#核函数开发" class="hash-link" aria-label="Direct link to 核函数开发" title="Direct link to 核函数开发">​</a></h4>
<p>本样例中使用多核并行计算，即把<font color="red"><b>数据进行分片，分配到多个核上进行处理</b></font>。Ascend C核函数是在一个核上的处理函数，所以 只处理部分数据。</p>
<p>分配方案是：假设共启用8个核，数据整体长度<code>TOTAL_LENGTH</code>为8 * 2048个元素，平均分配到8个核上运行，每个核上处理的数据大小<code>BLOCK_LENGTH</code>为2048个元素。下文的核函数，只关注长度为BLOCK_LENGTH的数据应该如何处理。</p>
<p>核函数的定义如下：</p>
<p>指针入参变量需要增加变量类型限定符<code>__gm__</code>，表明该指针变量指向<strong>Global Memory</strong>上某处内存地址。为了统一表达，使用GM_ADDR宏来修饰入参，GM_ADDR宏定义如下：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">GM_ADDR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">__gm__ </span><span class="token macro property expression keyword" style="color:#00009f">uint8_t</span><span class="token macro property expression operator" style="color:#393A34">*</span><br></span></code></pre></div></div>
<p>使用<code>__global__</code>函数类型限定符来标识它是一个核函数，可以被<code>&lt;&lt;&lt;&gt;&gt;&gt;</code>调用；使用<code>__aicore__</code>函数类型限定符来标识该核函数在设备端<strong>AI Core</strong>上执行。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token plain"> __global__ __aicore__ </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add_custom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GM_ADDR x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KernelAdd op</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// 算子类</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<font color="red" size="5"><b>算子类的Init函数，完成内存初始化相关工作，Process函数完成算子实现的核心逻辑。</b></font>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="demo中算子类的整体框架">Demo中算子类的整体框架<a href="#demo中算子类的整体框架" class="hash-link" aria-label="Direct link to Demo中算子类的整体框架" title="Direct link to Demo中算子类的整体框架">​</a></h5>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">KernelAdd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">KernelAdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化函数，完成内存初始化相关操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GM_ADDR x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 核心处理函数，实现算子逻辑，调用私有成 员函数CopyIn、Compute、CopyOut完成矢量算子的三级流水操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 搬入函数，从Global Memory搬运数据至Local Memory，被核心Process函数调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CopyIn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> progress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 计算函数，完成两个输入参数相加，得到最终结果，被核心Process函数调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Compute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> progress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 搬出函数，将最终结果从Local Memory搬运到Global Memory上，被核心Process函数调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CopyOut</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> progress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">TPipe pipe</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//TPipe内存管理对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">TQue</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">TPosition</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">VECIN</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFER_NUM</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> inQueueX</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inQueueY</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//输 入数据Queue队列管理对象，TPosition为VECIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">TQue</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">TPosition</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">VECOUT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFER_NUM</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> outQueueZ</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//输出数据Queue队列管理对象，TPosition为VECOUT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">GlobalTensor</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">half</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> xGm</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//管理输入输出Global Memory内存地址的对象，其中xGm, yGm为输入，zGm为输出</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">GlobalTensor</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">half</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> yGm</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">GlobalTensor</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">half</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> zGm</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="算子类中的init函数">算子类中的Init函数<a href="#算子类中的init函数" class="hash-link" aria-label="Direct link to 算子类中的Init函数" title="Direct link to 算子类中的Init函数">​</a></h5>
<p>初始化函数<strong>Init</strong>主要完成以下内容：设置输入输出Global Tensor的Global Memory内存地址，通过TPipe内存管理对象为输入输出Queue分配内存。</p>
<font color="red"><b>这里的Global Tensor作用就是将Global Memory中的数据进行切分，计算出每个Core应该负责的Global Memory的内存地址。 </b></font>
<font color="red"><b>GmAlloc和GmFree，而没有Gmmemcpy函数，因为通过这种方式申请的内存是在系统/tmp目录下生成的临时文件，并不是在  卡里面的，是存储在硬盘上的。</b></font>
<font color="red"><b>aclrtMalloc、aclrtMemcpy等函数，也是利用__gm__指针，将主机内存中的数据拷贝到设备内存上去</b></font>
<p><strong>本样例将数据切分成8块，平均分配到8个核上运行，每个核上处理的数据大小BLOCK_LENGTH为2048个元素。数据切分主要通过地址偏移来进行实现：</strong> 每个核上处理的数据地址需要在起始地址上增加<code>GetBlockIdx() * BLOCK_LENGTH</code>（每个block处理的数据长度）的<font color="red"><b>偏移</b></font>来获取。这样也就实现了多核并行计算的数据切分。</p>
<p>以输入x为例，<code>x + BLOCK_LENGTH * GetBlockIdx()</code>即为单核处理程序中x在Global Memory上的内存偏移地址，获取偏移地址后，使用GlobalTensor类的<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0007.html" target="_blank" rel="noopener noreferrer">SetGlobalBuffer</a>接口设定该核上Global Memory的起始地址以及长度。具体示意图如下。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427105727.png" alt="image.png|center|600" class="img_ev3q"></p>
<p>实现了在多核上的数据切分后，还需要在单核上进行进一步的数据切分（这是为什么？<strong>猜测可能是因为每个AI Core中的矩阵计算单元和向量计算单元都是固定大小的，每次切分出来都都得是符合这些硬件单元大小的切分</strong>）</p>
<p>对于单核上的处理数据，可以进行数据切块（Tiling），在本示例中，仅作为参考，将数据切分成8块（并不意味着8块就是性能最优）。切分后的每个数据块再次切分成2块，即可开启<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/devguide/opdevg/ascendcopdevg/atlas_ascendc_10_0090.html" target="_blank" rel="noopener noreferrer">double buffer</a>，实现流水线之间的并行。<font color="red"><b>可以将数据传入传出和计算过程进行重叠起来～</b></font></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427110311.png" alt="image.png|center|300" class="img_ev3q">
<center> <font face="华文宋体" size="4">双缓冲策略</font> </center></p>
<p>这样单核上的数据（2048个数）被切分成16块，每块TILE_LENGTH（128）个数据。TPipe为inQueueX分配了两块大小为TILE_LENGTH * sizeof(half)个字节的内存块，<strong>每个内存块能容纳TILE_LENGTH（128）个half类型数据</strong>。数据切分示意图如下：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427110118.png" alt="image.png|center|600" class="img_ev3q"></p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;kernel_operator.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> TOTAL_LENGTH </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                            </span><span class="token comment" style="color:#999988;font-style:italic">// total length of data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> USE_CORE_NUM </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                                   </span><span class="token comment" style="color:#999988;font-style:italic">// num of core used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> BLOCK_LENGTH </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TOTAL_LENGTH </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> USE_CORE_NUM</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">// length computed of each core</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> TILE_NUM </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                                       </span><span class="token comment" style="color:#999988;font-style:italic">// split data into 8 tiles for each core</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> BUFFER_NUM </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                                     </span><span class="token comment" style="color:#999988;font-style:italic">// tensor num for each queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> TILE_LENGTH </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BLOCK_LENGTH </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> TILE_NUM </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> BUFFER_NUM</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// separate to 2 parts, due to double buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 2048 / 16 = 128 符合了向量计算单元的大小，同时开启了双缓冲策略。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GM_ADDR x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// get start index for current core, core parallel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xGm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetGlobalBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__gm__ half</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> BLOCK_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetBlockIdx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BLOCK_LENGTH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    yGm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetGlobalBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__gm__ half</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> BLOCK_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetBlockIdx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BLOCK_LENGTH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zGm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetGlobalBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__gm__ half</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">z </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> BLOCK_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetBlockIdx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BLOCK_LENGTH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// pipe alloc memory to queue, the unit is Bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pipe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InitBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inQueueX</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFER_NUM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TILE_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">half</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pipe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InitBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inQueueY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFER_NUM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TILE_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">half</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pipe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InitBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outQueueZ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFER_NUM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TILE_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">half</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="算子类中的process函数">算子类中的Process函数<a href="#算子类中的process函数" class="hash-link" aria-label="Direct link to 算子类中的Process函数" title="Direct link to 算子类中的Process函数">​</a></h5>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427112725.png" alt="image.png|center|800" class="img_ev3q"></p>
<p>基于矢量编程范式，将核函数的实现分为3个基本任务：CopyIn，Compute，CopyOut。<strong>Process</strong>函数中通过如下方式调用这三个函数：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// loop count need to be doubled, due to double buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">constexpr</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> loopCount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TILE_NUM </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> BUFFER_NUM</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 这里之所以loopCount长这样，是因为每次loop都在一个AI Core上计算一次128位的向量加法。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// tiling strategy, pipeline parallel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> loopCount</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	    </span><span class="token comment" style="color:#999988;font-style:italic">// 相当于对每个AI Core中的数据通路进行了更加精细的控制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">CopyIn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Compute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">CopyOut</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="copyin函数">CopyIn函数<a href="#copyin函数" class="hash-link" aria-label="Direct link to CopyIn函数" title="Direct link to CopyIn函数">​</a></h5>
<ol>
<li>使用<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0101.html" target="_blank" rel="noopener noreferrer">DataCopy</a>接口将GlobalTensor数据拷贝到LocalTensor。</li>
<li>使用<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0140.html" target="_blank" rel="noopener noreferrer">EnQue</a>将LocalTensor放入VecIn的Queue中。</li>
</ol>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CopyIn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> progress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// alloc tensor from queue memory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LocalTensor</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">half</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> xLocal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inQueueX</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">AllocTensor</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">half</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LocalTensor</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">half</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> yLocal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inQueueY</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">AllocTensor</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">half</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// copy progress_th tile from global tensor to local tensor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">DataCopy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xLocal</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xGm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">progress </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> TILE_LENGTH</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TILE_LENGTH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">DataCopy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">yLocal</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> yGm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">progress </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> TILE_LENGTH</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TILE_LENGTH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// enque input tensors to VECIN queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inQueueX</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">EnQue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xLocal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inQueueY</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">EnQue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">yLocal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="compute函数">Compute函数<a href="#compute函数" class="hash-link" aria-label="Direct link to Compute函数" title="Direct link to Compute函数">​</a></h5>
<ol>
<li>使用<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0141.html" target="_blank" rel="noopener noreferrer">DeQue</a>从VecIn中取出LocalTensor。</li>
<li>使用Ascend C接口<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0035.html" target="_blank" rel="noopener noreferrer">Add</a>完成矢量计算。</li>
<li>使用<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0140.html" target="_blank" rel="noopener noreferrer">EnQue</a>将计算结果LocalTensor放入到VecOut的Queue中。</li>
<li>使用<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0139.html" target="_blank" rel="noopener noreferrer">FreeTensor</a>将释放不再使用的LocalTensor。</li>
</ol>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Compute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> progress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// deque input tensors from VECIN queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LocalTensor</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">half</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> xLocal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inQueueX</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">DeQue</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">half</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LocalTensor</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">half</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> yLocal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inQueueY</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">DeQue</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">half</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LocalTensor</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">half</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> zLocal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> outQueueZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">AllocTensor</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">half</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// call Add instr for computation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zLocal</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xLocal</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> yLocal</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TILE_LENGTH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// enque the output tensor to VECOUT queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outQueueZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">EnQue</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">half</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zLocal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// free input tensors for reuse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inQueueX</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FreeTensor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xLocal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inQueueY</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FreeTensor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">yLocal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="copyout函数">CopyOut函数<a href="#copyout函数" class="hash-link" aria-label="Direct link to CopyOut函数" title="Direct link to CopyOut函数">​</a></h5>
<ol>
<li>使用<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0141.html" target="_blank" rel="noopener noreferrer">DeQue</a>接口从VecOut的Queue中取出LocalTensor。</li>
<li>使用<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0101.html" target="_blank" rel="noopener noreferrer">DataCopy</a>接口将LocalTensor拷贝到GlobalTensor上。</li>
<li>使用<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0139.html" target="_blank" rel="noopener noreferrer">FreeTensor</a>将不再使用的LocalTensor进行回收。</li>
</ol>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> __aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CopyOut</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> progress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// deque output tensor from VECOUT queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LocalTensor</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">half</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> zLocal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> outQueueZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">DeQue</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">half</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// copy progress_th tile from local tensor to global tensor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">DataCopy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zGm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">progress </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> TILE_LENGTH</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zLocal</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TILE_LENGTH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// free output tensor for reuse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outQueueZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FreeTensor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zLocal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="核函数运行验证">核函数运行验证<a href="#核函数运行验证" class="hash-link" aria-label="Direct link to 核函数运行验证" title="Direct link to 核函数运行验证">​</a></h4>
<p>异构计算架构中，NPU（kernel侧）与CPU（host侧）是协同工作的，完成了kernel侧核函数开发后，即可编写host侧的核函数调用程序，实现从host侧的APP程序调用算子，执行计算过程。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="异构计算框架">异构计算框架<a href="#异构计算框架" class="hash-link" aria-label="Direct link to 异构计算框架" title="Direct link to 异构计算框架">​</a></h5>
<p>内置宏<code>ASCENDC_CPU_DEBUG</code>是区分运行CPU模式或NPU模式逻辑的标志，在同一个main函数中通过对<code>ASCENDC_CPU_DEBUG</code>宏定义的判断来区分CPU模式和NPU模式的运行程序。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;data_utils.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifndef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">ASCENDC_CPU_DEBUG</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;acl/acl.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add_custom_do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> coreDim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> l2ctrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;tikicpulib.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token plain"> __global__ __aicore__ </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add_custom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GM_ADDR x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t inputByteSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// uint16_t represent half</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t outputByteSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// uint16_t represent half</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> blockDim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">ASCENDC_CPU_DEBUG</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 用于CPU模式调试的调用程序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// NPU模式运行算子的调用程序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="cpu调试用的调试程序">CPU调试用的调试程序<a href="#cpu调试用的调试程序" class="hash-link" aria-label="Direct link to CPU调试用的调试程序" title="Direct link to CPU调试用的调试程序">​</a></h5>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427114644.png" alt="image.png|center|200" class="img_ev3q"></p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 使用GmAlloc分配共享内存，并进行数据初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GmAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GmAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> z </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GmAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ReadFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./input/input_x.bin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ReadFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./input/input_y.bin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 调用ICPU_RUN_KF调测宏，完成核函数CPU模式调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">SetKernelMode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">KernelMode</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">AIV_MODE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ICPU_RUN_KF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">add_custom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockDim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// use this macro for cpu debug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 输出数据写出</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">WriteFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./output/output_z.bin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> outputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 调用GmFree释放申请的资源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GmFree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GmFree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GmFree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="npu模式运行算子调试程序">NPU模式运行算子调试程序<a href="#npu模式运行算子调试程序" class="hash-link" aria-label="Direct link to NPU模式运行算子调试程序" title="Direct link to NPU模式运行算子调试程序">​</a></h5>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427114807.png" alt="image.png|center|150" class="img_ev3q"></p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// AscendCL初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclInit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 运行管理资源申请</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> deviceId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtSetDevice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deviceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aclrtStream stream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtCreateStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">stream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 分配Host内存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">xHost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">yHost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">zHost</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">xDevice</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">yDevice</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">zDevice</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtMallocHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">xHost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtMallocHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">yHost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtMallocHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">zHost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> outputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 分配Device内存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtMalloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">xDevice</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ACL_MEM_MALLOC_HUGE_FIRST</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtMalloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">yDevice</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ACL_MEM_MALLOC_HUGE_FIRST</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtMalloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">zDevice</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> outputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ACL_MEM_MALLOC_HUGE_FIRST</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Host内存初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ReadFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./input/input_x.bin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xHost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ReadFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./input/input_y.bin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> yHost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtMemcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xDevice</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xHost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ACL_MEMCPY_HOST_TO_DEVICE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtMemcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">yDevice</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> yHost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ACL_MEMCPY_HOST_TO_DEVICE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 用内核调用符&lt;&lt;&lt;&gt;&gt;&gt;调用核函数完成指定的运算,add_custom_do中封装了&lt;&lt;&lt;&gt;&gt;&gt;调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_custom_do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockDim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xDevice</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> yDevice</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zDevice</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtSynchronizeStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 将Device上的运算结果拷贝回Host</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtMemcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zHost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> outputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zDevice</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> outputByteSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ACL_MEMCPY_DEVICE_TO_HOST</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">WriteFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./output/output_z.bin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zHost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> outputByteSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 释放申请的资源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtFree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xDevice</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtFree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">yDevice</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtFree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zDevice</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtFreeHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xHost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtFreeHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">yHost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtFreeHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zHost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// AscendCL去初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtDestroyStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclrtResetDevice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deviceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_ACL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aclFinalize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-硬件架构">3-硬件架构<a href="#3-硬件架构" class="hash-link" aria-label="Direct link to 3-硬件架构" title="Direct link to 3-硬件架构">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-基本架构">3.1-基本架构<a href="#31-基本架构" class="hash-link" aria-label="Direct link to 3.1-基本架构" title="Direct link to 3.1-基本架构">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427120229.png" alt="image.png|center|600" class="img_ev3q"></p>
<p>AI Core负责执行标量、向量和张量相关的计算密集型算子，包括三种基础<strong>计算单元</strong>：Cube（矩阵）计算单元、Vector（向量）计算单元和Scalar（标量）计算单元，同时还包含<strong>存储单元</strong>（包括硬件存储和用于数据搬运的搬运单元）和<strong>控制单元</strong>。硬件架构根据Cube计算单元和Vector计算单元是否同核部署分为<strong>耦合架构</strong>和<strong>分离架构</strong>两种。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="耦合架构">耦合架构<a href="#耦合架构" class="hash-link" aria-label="Direct link to 耦合架构" title="Direct link to 耦合架构">​</a></h4>
<p>耦合架构是指Cube计算单元和Vector计算单元同核部署，架构图如下图所示，耦合架构中Cube计算单元和Vector计算单元共享同一个Scalar单元，统一加载所有的代码段。
<img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427120321.png" alt="image.png|center|500" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="分离架构">分离架构<a href="#分离架构" class="hash-link" aria-label="Direct link to 分离架构" title="Direct link to 分离架构">​</a></h4>
<p>分离架构将AI Core拆成矩阵计算（AI Cube，AIC）和向量计算（AI Vector，AIV）两个独立的核，每个核都有自己的Scalar单元，能独立加载自己的代码段，从而实现矩阵计算与向量计算的解耦，在系统软件的统一调度下互相配合达到计算效率优化的效果。AIV与AIC之间通过Global Memory进行数据传递。另外分离架构相比耦合架构，增加了两个Buffer：BT Buffer(BiasTable Buffer，存放Bias)和FP Buffer(Fixpipe Buffer，存放量化参数、Relu参数等)。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427120344.png" alt="image.png|center|500" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-计算单元">3.2-计算单元<a href="#32-计算单元" class="hash-link" aria-label="Direct link to 3.2-计算单元" title="Direct link to 3.2-计算单元">​</a></h3>
<p>计算单元是AI Core中提供强大算力的核心单元，包括三种基础<strong>计算单元</strong>：Cube（矩阵）计算单元、Vector（向量）计算单元和Scalar（标量）计算单元，完成AI Core中不同类型的数据计算。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="标量计算单元">标量计算单元<a href="#标量计算单元" class="hash-link" aria-label="Direct link to 标量计算单元" title="Direct link to 标量计算单元">​</a></h4>
<p>在AI Core架构中，<strong>Scalar</strong>主要负责各类标量数据运算与程序流程控制，功能上相当于一个简化版的小型CPU。<font color="red"><b>它承担循环控制、分支判断、Cube/Vector指令地址和参数计算、基本算术运算</b></font>等任务，同时能够通过事件同步模块插入同步符，控制AI Core内部其他执行单元的流水操作。需要注意的是，相比Host CPU，AI Core中的Scalar计算能力较弱，主要定位在指令发射层面，因此在实际应用中，应尽量减少Scalar上的计算负担，尤其是在性能调优时，要避免频繁的<code>if/else</code>分支和变量计算。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427120712.png" alt="image.png|center|300" class="img_ev3q"></p>
<p>从执行机制上看，Scalar在执行标量运算指令时，依赖标准的<strong>ALU（Arithmetic Logic Unit）</strong> 执行具体操作。其所需的代码段和数据段（栈空间）均来源于<strong>GM（Global Memory）</strong> 。为了提高效率，Scalar配备了<strong>ICache（Instruction Cache）</strong> 用于缓存代码段和<strong>DCache（Data Cache）</strong> 用于缓存数据段。ICache的大小通常与硬件规格有关，如16K或32K字节，按2K字节为单位加载；DCache大小同样与硬件规格相关，典型值为16K字节，按<strong>cacheline（64字节）</strong> 为单位加载。为最大化核内访问效率，应尽可能确保程序的代码段和数据段能够被完全缓存至ICache和DCache中，减少核外访问带来的延迟。此外，在DCache加载数据时，如果<font color="red"><b>内存首地址与cacheline对齐</b></font>（即64字节对齐），则数据加载效率最高。因此在程序设计和内存布局时，应特别关注对齐优化，以提升整体数据加载效率和程序执行性能。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="向量计算单元">向量计算单元<a href="#向量计算单元" class="hash-link" aria-label="Direct link to 向量计算单元" title="Direct link to 向量计算单元">​</a></h4>
<p>Vector负责执行向量运算。向量计算单元执行向量指令，类似于传统的单指令多数据（Single Instruction Multiple Data，SIMD）指令，每个向量指令可以完成多个操作数的同一类型运算。向量计算单元可以快速完成两个FP16类型的向量相加或者相乘。向量指令支持多次迭代执行，也支持对带有间隔的向量直接进行运算。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427120758.png" alt="image.png|center|300" class="img_ev3q"></p>
<p>Vector所有计算的源数据以及目标数据都要求存储在<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/devguide/opdevg/ascendcopdevg/atlas_ascendc_10_0010.html#ZH-CN_TOPIC_0000002263815169__table1692510612218" target="_blank" rel="noopener noreferrer">Unified Buffer</a>中，Vector指令的首地址和操作长度有对齐要求，通常要求32B对齐，具体对齐要求参考API的约束描述。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="矩阵计算单元">矩阵计算单元<a href="#矩阵计算单元" class="hash-link" aria-label="Direct link to 矩阵计算单元" title="Direct link to 矩阵计算单元">​</a></h4>
<p>Cube计算单元负责执行矩阵运算，一次执行即可完成A矩阵（M * K）与B矩阵（K * N）的矩阵乘。如下图所示红色虚线框划出了Cube计算单元及其访问的存储单元，其中L0A存储左矩阵，L0B存储右矩阵，L0C存储矩阵乘的结果和中间结果。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427120822.png" alt="image.png|center|400" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-存储单元">3.3-存储单元<a href="#33-存储单元" class="hash-link" aria-label="Direct link to 3.3-存储单元" title="Direct link to 3.3-存储单元">​</a></h3>
<p>AI Core中包含多级<strong>内部存储</strong>，AI Core需要把<strong>外部存储</strong>中的数据加载到内部存储中，才能完成相应的计算。AI Core的主要内部存储包括：L1 Buffer（L1缓冲区），L0 Buffer（L0缓冲区），Unified Buffer（统一缓冲区）等。</p>
<p>为了配合AI Core中的数据传输和搬运，AI Core中还包含<font color="red"><b>MTE</b></font>（Memory Transfer Engine，存储转换引擎）搬运单元，在搬运过程中可执行  随路数据格式/类型转换。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="34-控制单元">3.4-控制单元<a href="#34-控制单元" class="hash-link" aria-label="Direct link to 3.4-控制单元" title="Direct link to 3.4-控制单元">​</a></h3>
<p>控制单元为整个计算过程提供了指令控制，负责整个AI Core的运行。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427121007.png" alt="image.png|center|600" class="img_ev3q"></p>
<p>多条指令通过总线接口从系统内存进入到指令缓存（ICache）。
在后续指令执行过程中：</p>
<ul>
<li>若为Scalar指令，直接由Scalar单元执行；</li>
<li>若为其他类型指令，则由Scalar单元调度至五个独立分类指令队列（Vector指令队列、Cube指令队列、MTE1/MTE2/MTE3指令队列），由对应的执行单元处理。<font color="red"><b>单个指令队列内部严格按照指令进入顺序执行，不同指令队列之间可以并行执行，以提高整体执行效率</b></font>。
为了处理并行执行中潜在的数据依赖问题，<strong>系统通过事件同步模块插入同步指令</strong>，提供PipeBarrier与SetFlag/WaitFlag两种API实现同步控制。</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427121050.png" alt="image.png|center|800" class="img_ev3q"></p>
<p>PipeBarrier作为一条同步指令，用于约束单个指令队列内的执行顺序，确保所有前序指令的数据读写操作完成后，后序指令方可执行。SetFlag和WaitFlag则实现不同指令队列之间的同步关系，其中SetFlag指令在完成前序指令所有读写后设置同步标志位为1；WaitFlag指令在检测到标志位为0时阻塞后续指令，待标志位为1后自动清零并继续执行。</p>
<p>Ascend C提供了同步控制API，通常开发者无需手动管理同步，编程模型及范式会自 动处理同步控制，这是推荐的开发方式。但了解同步机制的原理仍然重要，尤其是在特殊情况下需要手动插入同步指令，以确保并行程序的正确性和高效性。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-编程模型">4-编程模型<a href="#4-编程模型" class="hash-link" aria-label="Direct link to 4-编程模型" title="Direct link to 4-编程模型">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-spmd模型ai-core之间的并行性来源">4.1-SPMD模型（AI Core之间的并行性来源）<a href="#41-spmd模型ai-core之间的并行性来源" class="hash-link" aria-label="Direct link to 4.1-SPMD模型（AI Core之间的并行性来源）" title="Direct link to 4.1-SPMD模型（AI Core之间的并行性来源）">​</a></h3>
<p>假设，从输入数据到输出数据需要经过3个阶段任务的处理（T1、T2、T3）。如下图所示，SPMD模式下，系统会启动一组进程，并行处理待处理的数据：<strong>首先待处理数据会被切分成多个数据分片，切分后的数据分片随后被分发给不同进程处理，每个进程接收到一个或多个数据分片，并独立地对这些分片进行3个任务的处理</strong>。</p>
<p>具体到Ascend C编程模型中的应用，是<font color="red"><b>将需要处理的数据拆分并同时在多个计算核心（类比于上文介绍中的多个进程）上运行</b></font>，从而获取更高的性能。多个AI Core共享相同的指令代码，<strong>每个核上的运行实例唯一的区别是block_idx不同，每个核通过不同的block_idx来识别自己的身份</strong>。block的概念类似于上文中进程的概念，block_idx就是标识进程唯一性的进程ID。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427121531.png" alt="image.png|center|400" class="img_ev3q"></p>
<p>算子被调用时，所有的计算核心都执行相同的实现代码，入口函数的入参也是相同的。每个核上处理的数据地址需要在起始地址上增加<code>GetBlockIdx()*BLOCK_LENGTH</code>（每个核处理的数据长度）的<font color="red"><b>偏移</b></font>来获取。这样也就实现了多核并行计算的数据切分。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">KernelAdd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">KernelAdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __aicore__ </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GM_ADDR x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 不同核根据各自的block_idx设置数据地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xGm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetGlobalBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__gm__ half</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> BLOCK_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetBlockIdx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BLOCK_LENGTH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        yGm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetGlobalBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__gm__ half</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> BLOCK_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetBlockIdx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BLOCK_LENGTH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        zGm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetGlobalBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__gm__ half</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">z </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> BLOCK_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token class-name">AscendC</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetBlockIdx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BLOCK_LENGTH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Queue初始化，单位为字节</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pipe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InitBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inQueueX</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFER_NUM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TILE_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">half</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pipe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InitBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inQueueY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFER_NUM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TILE_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">half</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pipe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InitBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outQueueZ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFER_NUM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TILE_LENGTH </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">half</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 实现核函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token plain"> __global__ __aicore__ </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add_custom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GM_ADDR x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GM_ADDR z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化算子类，算子类提供算子初始化和核心处理等方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KernelAdd op</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化函数，获取该核函数需要处理的输入输出地址，同时完成必要的内存初始化工作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 核心处理函数，完成算子的数据搬运与计算等核心逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-核函数">4.2-核函数<a href="#42-核函数" class="hash-link" aria-label="Direct link to 4.2-核函数" title="Direct link to 4.2-核函数">​</a></h3>
<p>和cuda的调用方式类似，只不过启用的不再是线程，而是一个block对应一个AI Core，类似于一个进程。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 实现核函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token plain"> __global__ __aicore__ </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add_custom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__gm__ </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __gm__ </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __gm__ </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化算子类，算子类提供算子初始化和核心处理等方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KernelAdd op</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化函数，获取该核函数需要处理的输入输出地址，同时完成必要的内存初始化工作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 核心处理函数，完成算子的数据搬运与计算等核心逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 调用核函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add_custom_do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> blockDim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> l2ctrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    add_custom</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockDim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> l2ctrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stream</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>注意：<strong>blockDim</strong>，规定了核函数将会在几个核上执行。每个执行该核函数的核会被分配一个逻辑ID，即block_idx，可以在核函数的实现中调用<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0185.html" target="_blank" rel="noopener noreferrer">GetBlockIdx</a>来获取block_idx；blockDim是逻辑核的概念，取值范围为[1,65535]。为了充分利用硬件资源，<strong>一般设置为物理核的核数或其倍数</strong>。对于耦合架构和分离架构，blockDim在运行时的意义和设置规则有一些区别，具体说明如下：</p>
<ul>
<li>耦合架构：由于其Vector、Cube单元是集成在一起的，blockDim用于设置启动多个AICore核实例执行，不区分Vector、Cube。AI Core的核数可以通过<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_1031.html" target="_blank" rel="noopener noreferrer">GetCoreNumAiv</a>或者<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_1030.html" target="_blank" rel="noopener noreferrer">GetCoreNumAic</a>获取。</li>
<li>分离架构<!-- -->
<ul>
<li>针对仅包含Vector计算的算子，blockDim用于设置启动多少个Vector（AIV）实例执行，比如某款AI处理器上有40个Vector核，建议设置为40。</li>
<li>针对仅包含Cube计算的算子，blockDim用于设置启动多少个Cube（AIC）实例执行，比如某款AI处理器上有20个Cube核，建议设置为20。</li>
<li>针对Vector/Cube融合计算的算子，启动时，按照AIV和AIC组合启动，blockDim用于设置启动多少个组合执行，比如某款AI处理器上有40个Vector核和20个Cube核，一个组合是2个Vector核和1个Cube核，建议设置为20，此时会启动20个组合，即40个Vector核和20个Cube核。<strong>注意：该场景下，设置的blockDim逻辑核的核数不能超过物理核（2个Vector核和1个Cube核组合为1个物理核）的核数。</strong></li>
<li>AIC/AIV的核数分别通过<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_1030.html" target="_blank" rel="noopener noreferrer">GetCoreNumAic</a>和<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_1031.html" target="_blank" rel="noopener noreferrer">GetCoreNumAiv</a>接口获取。</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-硬件架构的抽象">4.3-硬件架构的抽象<a href="#43-硬件架构的抽象" class="hash-link" aria-label="Direct link to 4.3-硬件架构的抽象" title="Direct link to 4.3-硬件架构的抽象">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427122218.png" alt="image.png|center|400" class="img_ev3q"></p>
<p>AI Core中包含<strong>计算单元、存储单元、搬运单元</strong>等核心组件。</p>
<ul>
<li>计算单元包括了三种基础计算资源：Cube计算单元、Vector计算单元和Scalar计算单元。</li>
<li>存储单元包括内部存储和外部存储：<!-- -->
<ul>
<li>AI Core的内部存储，统称为Local Memory，  对应的数据类型为LocalTensor。由于不同芯片间硬件资源不固定，可以为UB、L1、L0A、L0B等。</li>
<li>AI Core能够访问的外部存储称之为Global Memory，对应的数据类型为GlobalTensor。</li>
</ul>
</li>
<li>DMA（Direct Memory Access）搬运单元：负责数据搬运，包括Global Memory和Local Memory之间的数据搬运，以及不同层级Local Memory之间的数据搬运。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="44-编程范式">4.4-编程范式<a href="#44-编程范式" class="hash-link" aria-label="Direct link to 4.4-编程范式" title="Direct link to 4.4-编程范式">​</a></h3>
<p><strong>编程范式描述了算子实现的固定流程，基于编程范式进行编程，可以快速搭建算子实现的代码框架。</strong></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427142122.png" alt="image.png|center|600" class="img_ev3q"></p>
<p>Ascend C编程范式就是一种流水线式的编程范式，把算子核内的处理程序，分成多个<strong>流水任务</strong>，通过队列（Queue）完成<strong>任务间通信和同步</strong>，并通过统一的<strong>资源管理</strong>模块（Pipe）来统一管理内存、事件等资源。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="vector-编程范式">Vector 编程范式<a href="#vector-编程范式" class="hash-link" aria-label="Direct link to Vector 编程范式" title="Direct link to Vector 编程范式">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427142355.png" alt="image.png|center|600" class="img_ev3q"></p>
<p>如上图所示，Vector编程范式把算子的实现流程分为3个基本任务：CopyIn，Compute，CopyOut。</p>
<ul>
<li><strong>CopyIn</strong>负责搬入操作：将输入数据从Global Memory搬运到Local Memory（VECIN用于表达矢量计算搬入数据的存放位  置），完成搬运后执行入队列操作；</li>
<li><strong>Compute</strong>负责矢量指令计算操作：完成队列出队后，从Local Memory获取数据并计算，计算完成后执行入队操作；</li>
<li><strong>CopyOut</strong>负责搬出操作：完成队列出队后，将计算结果从Local Memory（VECOUT用于表达矢量计算搬出数据的存放位置）搬运到GM。</li>
</ul>
<p>上文中提到的VECIN/VECOUT是<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0174.html" target="_blank" rel="noopener noreferrer">TPosition</a>的概念。Ascend C管理不同层级的物理内存时，<strong>用一种抽象的逻辑位置（TPosition）来表达各级别的存储，代替了片上物理存储的概念</strong>，达到隐藏硬件架构的目的。除了VECIN/VECOUT，矢量编程中还会使用到VECCALC，一般在定义临时变量时使用此位置。这些TPosition与物理内存的映射关系如下表。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427142451.png" alt="image.png|center|600" class="img_ev3q"></p>
<p>详细的流程为：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427142613.png" alt="image.png|center|600" class="img_ev3q"></p>
<p>vector编程范式的指令流程为：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427143409.png" alt="image.png|center|500" class="img_ev3q"></p>
<p>任务间数据传递使用到的内存、事件等资源统一由管理模块Pipe进行管理。如下所示的内存管理示意图，TPipe通过<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0110.html" target="_blank" rel="noopener noreferrer">InitBuffer</a>接口对外提供Queue内 存初始化功能，开发者可以通过该接口为指定的Queue分配内存。</p>
<p>Queue队列内存初始化完成后，需要使用内存时，通过调用<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0138.html" target="_blank" rel="noopener noreferrer">AllocTensor</a>来为LocalTensor分配内存，当创建的LocalTensor完成相关计算无需再使用时，再调用<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0139.html" target="_blank" rel="noopener noreferrer">FreeTensor</a>来回收LocalTensor的内存。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427142643.png" alt="image.png|center|600" class="img_ev3q"></p>
<p>从运行图中可以看出，对于同一片数据，Stage1、Stage2、Stage3之间的处理具有依赖关系，需要串行处理；不同的数据切片，同一时间点，可以有多个任务在并行处理，由此达到任务并行、提升性能的目的。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427142719.png" alt="image.png|center|600" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="cube-编程范式">Cube 编程范式<a href="#cube-编程范式" class="hash-link" aria-label="Direct link to Cube 编程范式" title="Direct link to Cube 编程范式">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427142819.png" alt="image.png|center|600" class="img_ev3q"></p>
<p>和矢量编程范式一样，同样也使用逻辑位置（TPosition）来表达数据流，Cube编程范式中主要使用的逻辑位置定义如下：</p>
<ul>
<li>搬入数据的存放位置：A1，用于存放整块A矩阵，可类比CPU多级缓存中的二级缓存；</li>
<li>搬入数据的存放位置：B1，用于存放整块B矩阵，可类比CPU多级缓存中的二级缓存；</li>
<li>搬入数据的存放位置：C1，用于存放整块的矩阵乘偏置Bias矩阵，可类比CPU多级缓存中的二级缓存；</li>
<li>搬入数据的存放位置：A2，用于存放切分后的小块A矩阵，可类比CPU多级缓存中的一级缓存；</li>
<li>搬入数据的存放位置：B2，用于存放切分后的小块B矩阵，可类比CPU多级缓存中的一级缓存；</li>
<li>搬入数据的存放位置：C2，用于存放切分后的小块矩阵乘偏置Bias矩阵，可类比CPU多级缓存中的一级缓存；</li>
<li>结果数据的存放位置：CO1，用于存放小块结果C矩阵，可理解为Cube Out；</li>
<li>结果数据的存放位置：CO2，用于存放整块结果C矩阵，可理解为Cube Out；</li>
<li>搬入数据的存放位置：VECIN，用于矢量计算，实际业务在数据搬入Vector计算单元时使用此位置；</li>
<li>搬入数据的存放位置：VECCALC，用于矢量计算，实际业务一般在计算需要临时变量时使用此位置；</li>
<li>搬出数据的存放位置：VECOUT，用于矢量计算，实际业务在将Vector计算单元结果搬出时使用此位置。</li>
</ul>
<p>Cube计算流程同样也可以理解为CopyIn、Compute、CopyOut这几个阶段，因为流程相对复杂，<font color="red"><b>Matmul高阶API提供对此的高阶封装，简化了编程范式</b></font>。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427142912.png" alt="image.png|center|600" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="融合算子编程范式">融合算子编程范式<a href="#融合算子编程范式" class="hash-link" aria-label="Direct link to 融合算子编程范式" title="Direct link to 融合算子编程范式">​</a></h4>
<p>支持Vector与Cube混合计算的算子称之为融合算子。Ascend C提供<strong>融合算子的编程范式</strong>，方便开发者基于该范式表达融合算子的数据流，快速实现自己的融合算子。<strong>融合算子数据流</strong>指融合算子的输入输出在各存储位置间的流向。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427143130.png" alt="image.png|center|600" class="img_ev3q"></p>
<p>基于Matmul高阶API的融合算子编程范式，对上述数据流简化表达如下：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427143147.png" alt="center|600" class="img_ev3q"></p>
<p>流程如下：</p>
<ol>
<li>初始化一个MatMul对象，将输入数据从Global Memory搬运到Cube核上。</li>
<li>进行MatMul内部的计算。</li>
<li>将MatMul的计算结果搬运到Vector核上。</li>
<li>进行Vector矢量计算。</li>
<li>将输出结果搬运到Global Memory上。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-编程api">5-编程API<a href="#5-编程api" class="hash-link" aria-label="Direct link to 5-编程API" title="Direct link to 5-编程API">​</a></h2>
<p>Ascend C提供一组类库API，开发者使用标准C++语法和类库API进行编程。Ascend C编程类库API示意图如下所示，分为：</p>
<ul>
<li><strong>Kernel API</strong>：用于实现算子核函数的API接口。包括：<!-- -->
<ul>
<li><strong>基本数据结构：</strong> kernel API中使用到的基本数据结构，比如GlobalTensor和LocalTensor。</li>
<li><strong>基础API：</strong> 实现对硬件能力的抽象，开放芯片的能力，保证完备性和兼容性。标注为ISASI（Instruction Set Architecture Special Interface，硬件体系结构相关的接口）类别的API，不能保证跨硬件版本兼容。</li>
<li><strong>高阶API：</strong> 实现一些常用的计算算法，用于提高编程开发效率，通常会调用多种基础API实现。高阶API包括数学库、Matmul、Softmax等API。高阶API可以保证兼容性。</li>
</ul>
</li>
<li><strong>Host API</strong>：<!-- -->
<ul>
<li>高阶API配套的Tiling API：kernel侧高阶API配套的Tiling API，方便开发者获取kernel计算时所需的Tiling参数。</li>
<li>Ascend C算子原型注册与管理API：用于Ascend C算子原型定义和注册的API。</li>
<li>Tiling数据结构注册API：用于Ascend C算子TilingData数据结构定义和注册的API。</li>
<li>平台信息获取API：在实现Host侧的Tiling函数时，可能需要获取一些硬件平台的信息，来支撑Tiling的计算，比如获取硬件平台的核数等信息。平台信息获取API提供获取这些平台信息的功能。</li>
</ul>
</li>
<li><strong>算子调测API</strong>：用于算子调测的API，包括孪生调试，性能调测等。</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/NEUQer-xing/Markdown_images@master/images-2/20250427143710.png" alt="image.png|center|600" class="img_ev3q"></p>
<p><strong>对于基础API，主要分为以下几类：</strong></p>
<ul>
<li><strong><a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0003.html#ZH-CN_TOPIC_0000002263727309__table339023582010" target="_blank" rel="noopener noreferrer">标量计算API</a></strong>，实现调用Scalar计算单元执行计算的功能。</li>
<li><strong><a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0003.html#ZH-CN_TOPIC_0000002263727309__table107281858237" target="_blank" rel="noopener noreferrer">矢量计算API</a></strong>，实现调用Vector计算单元执行计算的功能。</li>
<li><strong><a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0236.html" target="_blank" rel="noopener noreferrer">矩阵计算API</a></strong>，实现调用Cube计算  单元执行计算的功能。</li>
<li><strong><a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0003.html#ZH-CN_TOPIC_0000002263727309__table1199372172410" target="_blank" rel="noopener noreferrer">数据搬运API</a></strong>，计算API基于Local Memory数据进行计算，所以数据需要先从Global Memory搬运至Local Memory，再使用计算API完成计算，最后从Local Memory搬出至Global Memory。执行搬运过程的接口称之为数据搬运API，比如DataCopy接口。</li>
<li><strong><a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/apiref/ascendcopapi/atlasascendc_api_07_0003.html#ZH-CN_TOPIC_0000002263727309__table1267664316264" target="_blank" rel="noopener noreferrer">内存管理与同步控制API</a></strong>
<ul>
<li>内存管理API，用于分配管理内存，比如AllocTensor、FreeTensor接口;</li>
<li>同步控制API，完成任务间的通信和同步，比如EnQue、DeQue接口。不同的API指令间有可能存在依赖关系，从<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/81RC1alpha002/devguide/opdevg/ascendcopdevg/atlas_ascendc_10_0015.html" target="_blank" rel="noopener noreferrer">硬件架构抽象</a>可知，不同的指令异步并行执行，为了保证不同指令队列间的指令按照正确的逻辑关系执行，需要向不同的组件发送同步指令。同步控制API内部即完成这个发送同步指令的过程，开发者无需关注内部实现逻辑，使用简单的API接口即可完成。</li>
</ul>
</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://buaaer-xing.github.io/docs/blogs/7-CANN异构架构/3-Ascend C编程语言.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/blogs/CANN异构架构/CANN是什么？"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">CANN是什么？</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/blogs/CANN异构架构/AOL算子加速库"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">AOL算子加速库</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-ascend-c-简介" class="table-of-contents__link toc-highlight">1-Ascend C 简介</a></li><li><a href="#2-使用ascend-c的demo" class="table-of-contents__link toc-highlight">2-使用Ascend C的Demo</a><ul><li><a href="#21-核函数输出hello-world" class="table-of-contents__link toc-highlight">2.1-核函数输出Hello World</a></li><li><a href="#22-核函数计算两个向量加法demo" class="table-of-contents__link toc-highlight">2.2-核函数计算两个向量加法Demo</a></li></ul></li><li><a href="#3-硬件架构" class="table-of-contents__link toc-highlight">3-硬件架构</a><ul><li><a href="#31-基本架构" class="table-of-contents__link toc-highlight">3.1-基本架构</a></li><li><a href="#32-计算单元" class="table-of-contents__link toc-highlight">3.2-计算单元</a></li><li><a href="#33-存储单元" class="table-of-contents__link toc-highlight">3.3-存储单元</a></li><li><a href="#34-控制单元" class="table-of-contents__link toc-highlight">3.4-控制单元</a></li></ul></li><li><a href="#4-编程模型" class="table-of-contents__link toc-highlight">4-编程模型</a><ul><li><a href="#41-spmd模型ai-core之间的并行性来源" class="table-of-contents__link toc-highlight">4.1-SPMD模型（AI Core之间的并行性来源）</a></li><li><a href="#42-核函数" class="table-of-contents__link toc-highlight">4.2-核函数</a></li><li><a href="#43-硬件架构的抽象" class="table-of-contents__link toc-highlight">4.3-硬件架构的抽象</a></li><li><a href="#44-编程范式" class="table-of-contents__link toc-highlight">4.4-编程范式</a></li></ul></li><li><a href="#5-编程api" class="table-of-contents__link toc-highlight">5-编程API</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/paper_notes_intro">论文笔记</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/blogs_intro">个人博客</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">相关内容</a></li><li class="footer__item"><a class="footer__link-item" href="/resume">个人简历</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://t.me/cx_cst" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://blog.csdn.net/qq_45575167" target="_blank" rel="noopener noreferrer" class="footer__link-item">CSDN</a></li><li class="footer__item"><a href="https://github.com/BUAAer-xing" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 BUAAer-xing, 此网站使用 Docusaurus 进行构建✨</div></div></div></footer></div>
</body>
</html>